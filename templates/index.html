<!DOCTYPE html>
<html>

<body>
  <div style="
        display: flex;
        flex-direction: column;
        width: 100%;
        justify-content: center;
        align-items: center;
      ">
    <h1>Actor Detector CVCS - Live Demo</h1>
    <button onclick="extractFrame()">Extract Frame</button>
    <h2>
      Pause the video or click the button above when you want to classify
    </h2>
    <input type="file" id="videoInput" accept="video/*">
    <video id="myVideo" width="1000" controls>
      <source src="static/video/GOT.mp4" type="video/mp4" />
      Your browser does not support HTML video.
    </video>
    <h3 style="color: red;" id="error"></h3>
    <h3 style="color: blue;" id="loading"></h3>
    <div style="
    display: flex;
    flex-direction: row;
    width: 100%;
    justify-content: space-evenly;
    align-items: center;
  "> <canvas hidden="true" id="canvas"></canvas>
      <div id="inference" hidden="true">
        <h3 style="text-align: center;"> prediction: </h3>
        <img width="1000" id="canvasClassify"></img>
      </div>
    </div>
  </div>
  <script type="text/JavaScript">
        const videoInput = document.getElementById('videoInput');
        var video = document.getElementById('myVideo');
        videoInput.addEventListener('change', function() {
          let file = this.files[0];
          if(!file) 
            file = "static/video/GOT.mp4";
          const videoURL = URL.createObjectURL(file);
          video.src = videoURL;
        });
        video.addEventListener('pause', function() {
          // Code to be executed when the video is paused
          console.log('Video paused');
          extractFrame();
        });
       function extractFrame() {
        document.getElementById("loading").innerHTML = "loading...";
        document.getElementById("error").innerHTML = "";
        document.getElementById("inference").hidden = true;
        // var video = document.getElementById('myVideo');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        // Pause the video
        video.pause();

        // Set the canvas dimensions to match the video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw the current frame onto the canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);  
        
        // Get the image data from the canvas as a data URL
        //var dataURL = canvas.toDataURL();//base64

        // // Display the image
        // var img = new Image();
        // img.src = dataURL;
        // document.body.write(img);
        classify(canvas);
      }

      function classify (img) {
        w = img.width;
        h = img.height;
        canvas.toBlob(function(blob) {
          imageBlob = blob;

          var formData = new FormData();
          formData.append('image', imageBlob, 'image.jpg');
          fetch('/classify', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(response => {
              //console.log('Image uploaded successfully',response.blob());
              // var canvas = document.getElementById('canvasClassify');
              // var context = canvas.getContext('2d');              
              // // Draw the current frame onto the canvas
              // // context.drawImage(video, 0, 0, canvas.width, canvas.height);
              // context.drawImage(response.body, 0, 0, w, h);
              console.log(response);



                if (response["msg"]){
                  document.getElementById("error").innerHTML = response["msg"];

                }else{
                  document.getElementById("error").innerHTML = "";
                                  // create an image
                var outputImg = document.getElementById('canvasClassify');
                outputImg.src = response["image"];
                document.getElementById("inference").hidden = false;
                }
                document.getElementById("loading").innerHTML = "";
              

            
          })
          .catch(error => {
            console.error('Error:', error);
          });
        }, 'image/jpeg', 1.0);
      }
    </script>
</body>

</html>